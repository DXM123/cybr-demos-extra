---
# This will create the NS for our demo
apiVersion: v1
kind: Namespace
metadata:
  name: conjur-followers-jwt
---
# This ServiceAccount provides the Kubernetes RBAC identity for the Conjur Kubernetes authenticator
apiVersion: v1
kind: ServiceAccount
metadata:
  name: conjur-demo-acct
  namespace: conjur-followers-jwt
---
# This Role defines the Kubernetes API access permissions that the Conjur
# authenticator will require in order to validate application identities.
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: conjur-role
  namespace: conjur-followers-jwt
rules:
  - apiGroups: [""] # "" indicates the core API group
    resources: ["pods", "serviceaccounts"]
    verbs: ["get", "list"]
  - apiGroups: ["extensions"]
    resources: ["deployments", "replicasets"]
    verbs: ["get", "list"]
  - apiGroups: ["apps"]
    resources: ["deployments", "statefulsets", "replicasets"]
    verbs: ["get", "list"]
  - apiGroups: [""]
    resources: ["pods/exec"]
    verbs: ["create", "get"]
---
# The Authenticator RoleBinding grants permissions to the Conjur Authenticator ServiceAccount
# for the authenticator Role, which provides a list of Kubernetes API access permissions.
# This is required to validate application identities.
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: conjur-role-binding
  namespace: conjur-followers-jwt
subjects:
- kind: ServiceAccount
  name: conjur-demo-acct
  namespace: conjur-followers-jwt
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: conjur-role
---
# This will config map will hold connection details that our container will use to authenticate to Conjur
kind: ConfigMap
apiVersion: v1
metadata:
  name: conjur-connect
  namespace: conjur-followers-jwt
data:
  CONJUR_ACCOUNT: demo
  #CONJUR_LEADER_APPLIANCE_URL: "https://ec2-3-10-224-97.eu-west-2.compute.amazonaws.com:8443"
  CONJUR_APPLIANCE_URL: "https://ec2-3-10-224-97.eu-west-2.compute.amazonaws.com:8443"
  CONJUR_SEED_FILE_URL: "https://ec2-3-10-224-97.eu-west-2.compute.amazonaws.com:8443/configuration/demo/seed"
  CONJUR_AUTHN_URL: "https://ec2-3-10-224-97.eu-west-2.compute.amazonaws.com:8443/authn-jwt/k8s-cluster1"
  SEEDFILE_DIR: "/tmp/seedfile"
  FOLLOWER_HOSTNAME: "conjur-follower-k8s-cluster"
  AUTHENTICATOR_ID: "k8s-cluster1"
  CONJUR_AUTHN_LOGIN: "host/followers/system:serviceaccount:conjur-followers-jwt:conjur-demo-acct"
  CONJUR_SSL_CERTIFICATE: |
    -----BEGIN CERTIFICATE-----
    MIIEMzCCAxugAwIBAgIUAtvFPCfH5XUBlzAknXzPbV400dcwDQYJKoZIhvcNAQEL
    BQAwWDENMAsGA1UECgwEZGVtbzESMBAGA1UECwwJQ29uanVyIENBMTMwMQYDVQQD
    DCppcC0xNzItMTYtMC0xMjguZXUtd2VzdC0yLmNvbXB1dGUuaW50ZXJuYWwwHhcN
    MjIxMDIwMDcwNTEyWhcNMzIxMDE3MDcwNTEyWjA1MTMwMQYDVQQDDCppcC0xNzIt
    MTYtMC0xMjguZXUtd2VzdC0yLmNvbXB1dGUuaW50ZXJuYWwwggEiMA0GCSqGSIb3
    DQEBAQUAA4IBDwAwggEKAoIBAQCujz82LEsAv5ozuQG5OJZFI+YMrTbXyk9DtHM5
    wzPimsV/wgOmlrtQ9gVrss00qG5KAlskboo2RZHQOQG505FeBwEnN8cvfjbm8vsH
    6R+BMBODeL1kYM24frA/GTvvLdGcNYnU8AoNGhm6z8YizQaKjXPtijOQTn2wXHPN
    aRZh8S1Ot4yuHD4eySAfUMhmw3Gwmi3KD236optJo0AxdjV28BjXDSYdlPf+rT9i
    c91Z2ebvQNu8DMCcgXql6HrKbJTTSdjcYdhtloiM6yYFRxsDeXnybnxmMEhy10WK
    2tgXRLkCCmAYdfsh/59+24xyCYgIbIIN6RXquXjEwdhIhi4VAgMBAAGjggEWMIIB
    EjAOBgNVHQ8BAf8EBAMCBaAwHQYDVR0OBBYEFNo5o+5ea0sNMlW/75VgGJCv2AcJ
    MIHgBgNVHREEgdgwgdWCKmlwLTE3Mi0xNi0wLTEyOC5ldS13ZXN0LTIuY29tcHV0
    ZS5pbnRlcm5hbIIPaXAtMTcyLTE2LTAtMTI4gjJlYzItMzUtMTc4LTI0NC0xMzAu
    ZXUtd2VzdC0yLmNvbXB1dGUuYW1hem9uYXdzLmNvbYIqaXAtMTcyLTE2LTAtMTI4
    LmV1LXdlc3QtMi5jb21wdXRlLmludGVybmFsgglsb2NhbGhvc3SCCTEyNy4wLjAu
    MYIOMzUuMTc4LjI0NC4xMzCCDDE3Mi4xNi4wLjEyOIICLWYwDQYJKoZIhvcNAQEL
    BQADggEBAMtSB55eXAJ+hgzn/+NdCR3CpYDm5TrrBQqLIBRm19SbkVy/8OLk+wpz
    g1zQcr1Snr8Ib/kpUYJ+Uky1KC2fCefRiVRUMz+BXMflohY25ynJWPY+2Tj5vwzX
    ynDoP12gQ7BKM6+mpazY7MZAfPRUnlommdemT34ovbVwJE9sWCUR2gUsGUOCSRwX
    rrBstx2i0XnHn3zGJz8GcQe3Yu44UKWY2wjSDyBK31mu1F/5hnX/tnDKsh9N8F0m
    LBklRcATQkcBo/pXUYketIVMi3ffhmSw2p9ajBd5HRM/M2z5fcTBvKE76RLQWfS5
    Sfjse5XNhba4fClfFLqaExQqMqNK3OE=
    -----END CERTIFICATE-----
    -----BEGIN CERTIFICATE-----
    MIID2jCCAsKgAwIBAgIJAKK4qMhXYrZgMA0GCSqGSIb3DQEBCwUAMFgxDTALBgNV
    BAoMBGRlbW8xEjAQBgNVBAsMCUNvbmp1ciBDQTEzMDEGA1UEAwwqaXAtMTcyLTE2
    LTAtMTI4LmV1LXdlc3QtMi5jb21wdXRlLmludGVybmFsMB4XDTIyMTAxOTE2NDAx
    OFoXDTMyMTAxNjE2NDAxOFowWDENMAsGA1UECgwEZGVtbzESMBAGA1UECwwJQ29u
    anVyIENBMTMwMQYDVQQDDCppcC0xNzItMTYtMC0xMjguZXUtd2VzdC0yLmNvbXB1
    dGUuaW50ZXJuYWwwggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQDc8qPM
    yNzxlarzLVPMocbhvJzDNbepVC7BwL4Wsn+HD+N2OmXBvW8d48Ndm68xPsqVbvft
    Av+Ox/tfod+M7xkVHj1plG7Iepgf7qgoaDd8sQgzYoVrmQWMnO/UyBMlthrb0iIs
    64hTQE9sR3fFOXDWPInKFEVJkOfatqls4WtQWRl/lL7hAKFFWMBGRCTO5Ix+N1fL
    9dMyNiPuFtgCtgz10oYAKGAUHF4roaQ2eFiCpvLA7UfYAQGS+homp0HLR6F+ayrw
    xwekdkgoDJXpq75Zyks1BJrovI+dWp58PFuAbgYV8QYtILBAelj8xoJ5eJtF2sKF
    ACqf0UNDpqAmZaVrAgMBAAGjgaYwgaMwRgYDVR0RBD8wPYIqaXAtMTcyLTE2LTAt
    MTI4LmV1LXdlc3QtMi5jb21wdXRlLmludGVybmFsgg9pcC0xNzItMTYtMC0xMjgw
    HQYDVR0OBBYEFPwTwfiJLOp5m0iMifHiI1QYjNGqMB8GA1UdIwQYMBaAFPwTwfiJ
    LOp5m0iMifHiI1QYjNGqMAwGA1UdEwQFMAMBAf8wCwYDVR0PBAQDAgHmMA0GCSqG
    SIb3DQEBCwUAA4IBAQDK8WcnJ+SK41YStRc++UXDIqkCQxkGLnRYc55fmwFW2ne2
    o+QHuLcXd3aM9+IO1/RdyAf/pi7/tJhNN0mr8IuWEv9VN+v+U6hWM6fj09viuw/k
    HJJG8B1uz2+cfqw3+WIJYIY3Z1JWpqCSoxrEx/rbBL3yEe9N8Uj4TERDdMTnYvlw
    74NIrLGW3WE9cienr9Kfw8pIiSCUVoDrXYkpKOb/4gMBx5dM8dTIbi0X3+7A1JNV
    ya9ilIuKMe4E/XcOovuJr+TQ9jhqqVnjMX0Mg0CENlsLtXO8cF7OvE2kK0fPbQZB
    HUzaAfP+x0ULYBq43/wvzkClUAOgWr8wGcCGnJoM
    -----END CERTIFICATE-----
---
kind: ConfigMap
apiVersion: v1
metadata:
  name: conjur-followers-authn-config
  namespace: conjur-followers-jwt
data:
  conjur.yml: |
    #List of authenticators enabled for this node
      authenticators:
        - authn-k8s/demo-application
        - authn-jwt/k8s-cluster1,
        - authn-k8s/k8s-cluster1
---